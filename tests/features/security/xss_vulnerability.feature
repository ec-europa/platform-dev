@api
Feature: Xss Vulnerability
  In order to control the xss vulnerability
  As an Administrator
  I need to test xss vulnerability in the platform

  Background:
    Given I am logged in as a user with the 'administrator' role

  @javascript @api @theme_wip
  # It is in wip because of the steps:
  # - And the response should contain "&lt;script&gt;alert('xss alert');&lt;/script&gt;"
  # - And the response should not contain "<script>alert('xss alert');</script>"
  # It is due to the absence of the Caption in the file field display.
  # The cause is the field component is not implemented yet.
  # It will be done with the ticket NEPT-1066
  Scenario: Test the caption field of an Image Field.
    When I go to "node/add/article"
    And I fill in "Title" with "Article with xss Code in an image"
    And I attach the file "/tests/files/logo.png" to "edit-field-image-und-0-upload"
    And I press "Save"
    Then the response should contain "has been created."
    When I go to "/admin/content/file"
    And I click "logo.png"
    And I click "Edit"
    And I fill in "File name" with "test_xss.png"
    And I fill in "Caption" with "<script>alert('xss alert');</script>"
    And I press "Save"
    And the response should contain "has been updated."
    When I go to "/admin/content"
    And the cache has been cleared
    And I click "Article with xss Code in an image"
    And the response should contain "&lt;script&gt;alert('xss alert');&lt;/script&gt;"
    And the response should not contain "<script>alert('xss alert');</script>"

   Scenario: With existing text formats, test the "Sanitize HTML" filter is never disabled if
   the "Display any HTML as plain text" one is not in a "text format"
     When I go to "/admin/config/content/formats/filtered_html"
     And I uncheck the box "Sanitize HTML"
     And I press "Save configuration"
     Then I should see the success message "The text format Filtered HTML has been updated."
     And the "Sanitize HTML" checkbox should be checked
     When I go to "admin/config/content/formats/plain_text"
     And I check the box "Display any HTML as plain text"
     And I uncheck the box "Sanitize HTML"
     And I press "Save configuration"
     Then I should see the success message "The text format Plain text has been updated."
     And the "Sanitize HTML" checkbox should not be checked
     And the "Display any HTML as plain text" checkbox should be checked

  @javascript
  Scenario: With new text formats, test the "Sanitize HTML" filter is never disabled if
  the "Display any HTML as plain text" one is not in a "text format"
    When I go to "admin/config/content/formats/add"
    And I fill in "Name" with "Dummy format"
    And I uncheck the box "Sanitize HTML"
    And I check "Convert URLs into links"
    And I check "Convert all characters to US-ASCII"
    And I press "Save configuration"
    Then I should see the success message "Added text format Dummy format."
    When I go to "admin/config/content/formats/dummy_format"
    Then the "Sanitize HTML" checkbox should be checked
    When I go to "admin/config/content/formats/add"
    And I fill in "Name" with "Dummy format 2"
    And I uncheck the box "Sanitize HTML"
    And I check "Display any HTML as plain text"
    And I check "Convert URLs into links"
    And I check "Convert all characters to US-ASCII"
    And I press "Save configuration"
    Then I should see the success message "Added text format Dummy format 2."
    When I go to "admin/config/content/formats/dummy_format_2"
    And the "Sanitize HTML" checkbox should not be checked
    And the "Display any HTML as plain text" checkbox should be checked

