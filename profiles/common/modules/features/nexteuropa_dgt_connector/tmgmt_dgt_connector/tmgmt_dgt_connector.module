<?php

/**
 * @file
 * Module file of the TMGMT DGT connector.
 */

define('TMGMT_DGT_CONNECTOR_MAX_SMALLJOB_LENGTH', 300);
define('TMGMT_DGT_CONNECTOR_TRANSLATOR_NAME', 'tmgmt_dgt_connector');

module_load_include('inc', 'tmgmt_dgt_connector');

/**
 * Implements hook_permission().
 */
function tmgmt_dgt_connector_permission() {
  return array(
    'administer dgt connector' => array(
      'title' => 'Administer DGT Connector features',
      'description' => 'Allows to administer of the DGT Connector features.',
    ),
  );
}

/**
 * Implements hook_menu().
 */
function tmgmt_dgt_connector_menu() {
  $items = array();

  $items['tmgmt_dgt_connector/server'] = array(
    'page callback' => '\Drupal\\tmgmt_dgt_connector\\Server::endpoint',
    // Authentication is done within the service.
    'access callback' => TRUE,
  );

  $items['tmgmt_dgt_connector/DGTServicesIntegration.wsdl'] = array(
    'page callback' => '\Drupal\\tmgmt_dgt_connector\\Server::wsdl',
    // Authentication is done within the service.
    'access callback' => TRUE,
  );

  $items['admin/config/system/dgt_connector'] = array(
    'title' => 'TMGMT DGT Connector - Configuration',
    'description' => 'Configuration of the TMGMT DGT Connector.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tmgmt_dgt_connector_admin_settings_form'),
    'access arguments' => array('administer dgt connector'),
    'file' => 'tmgmt_dgt_connector.admin.inc',
  );

  $items['admin/config/system/dgt_connector/general'] = array(
    'title' => 'General settings',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );

  return $items;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Change the form on the 'Translate' tab to provide the
 * nexteuropa_dgt_connector module functionalities.
 */
function tmgmt_dgt_connector_form_tmgmt_entity_ui_translate_form_alter(&$form, &$form_state) {
  // Set plugin for #cart .
  if (isset($form_state['tmgmt_cart'])) {
    $form_state['tmgmt_cart']['plugin'] = 'workbench_moderation';
  }

  $entity = $form_state['entity'];
  $cart = $form_state['tmgmt_cart'];
  list($entity_id) = entity_extract_ids($entity->entity_type, $entity);

  $source_data = _tmgmt_dgt_connector_get_source_data($cart['plugin'], $entity->entity_type, $entity_id);
  $length = 0;
  _tmgmt_dgt_connector_count_source_data($length, $source_data);

  if ($length > TMGMT_DGT_CONNECTOR_MAX_SMALLJOB_LENGTH) {
    // Remove add to cart button.
    unset($form['top_actions']);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function tmgmt_dgt_connector_form_tmgmt_ui_cart_content_alter(&$form, &$form_state) {

  // Remove "Enforce source language" option, not interesting for our case.
  $form['enforced_source_language']['#type'] = 'hidden';

  // Add a callback function when submiting.
  $form['request_translation']['#submit'] = array('_tmgmt_dgt_connector_workbench_store_request_languages_callback');
}

/**
 * Implements hook_entity_info_alter().
 */
function tmgmt_dgt_connector_entity_info_alter(&$entity_info) {
  $entity_info['tmgmt_job']['controller class'] = 'TMGMTPoetryJobController';
  $entity_info['tmgmt_job']['entity class'] = 'TMGMTPoetryJob';
  $entity_info['tmgmt_translator']['access callback'] = '_tmgmt_dgt_connector_translator_access';
}

/**
 * Implements hook_tmgmt_translator_plugin_info().
 */
function tmgmt_dgt_connector_tmgmt_translator_plugin_info() {
  return array(
    'tmgmt_dgt_connector' => array(
      'label' => t('TMGMT DGT Connector'),
      'description' => t('TMGMT DGT Connector Translation service.'),
      'plugin controller class' => 'TmgmtDgtConnectorTranslatorPluginController',
      'ui controller class' => 'TmgmtDgtConnectorTranslatorUIController',
    ),
  );
}
