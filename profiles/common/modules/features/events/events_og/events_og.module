<?php
/**
 * @file
 * Code for the Events feature.
 */

include_once 'events_og.features.inc';
include_once 'events_og.views_alter.inc';

/**
 * Implements hook_menu().
 */
function events_og_menu() {
  $items = array();

  $items['community/%group_name/calendar'] = array(
    'title' => 'Events',
    'page callback' => 'views_page',
    'page arguments' => array('calendar', 'month', 1),
    'access callback' => TRUE,
    'type' => MENU_NORMAL_ITEM,
    'menu_name' => 'menu-communities-menu',
    'weight' => 1,
  );

  return $items;
}

/**
 * Implements hook_og_context_negotiation_info().
 */
function events_og_og_context_negotiation_info() {
  $providers = array();

  $providers['calendar'] = array(
    'name' => t('Calendar'),
    'description' => t("Determine context by checking if an event is a group or a group content."),
    'callback' => 'og_context_handler_calendar',
    'menu path' => array('community/%'),
  );

  return $providers;
}

/**
 * Context handler; Get groups from events.
 */
function og_context_handler_calendar() {
  global $language;

  $keyword = 'community';

  $path = language_url_split_suffix(request_path(), [$language]);

  $path_args = explode('/', $path[1]);

  // Look for the community keyword in the path.
  if ($path_args[0] === $keyword) {
    $community_path = drupal_lookup_path('source', $path_args[0] . '/' . $path_args[1], $language->language);

    // If no path was found, then it's not a community in particular.
    if ($community_path !== FALSE) {
      $community_path = explode('/', $community_path);

      // Check that the node acts as a group.
      $node = node_load($community_path[1]);

      if (og_is_group('node', $node)) {
        return [
          'node' => [
            $node->nid,
          ],
        ];
      }
    }
  }
  return [];
}
