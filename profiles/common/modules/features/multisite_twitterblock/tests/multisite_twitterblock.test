<?php

/**
 * @file
 * Tests for multisite_twitterblock.module.
 *
 * ECWeb MULTISITE QA.
 */

/**
 * Defines a base class for testing the multisite twitterblock module.
 */
class MultisiteTwitterblockDevelopmentQA extends DrupalWebTestCase {

  protected $adminUser = NULL;
  protected $basicUser = NULL;
  protected $configuration = array(
    'multisite_twitterblock_type' => 'smk-twitter_search',
    'multisite_twitterblock_title' => 'Some twitter widget',
    'multisite_twitterblock_slug' => 'cloud-influencers',
    'multisite_twitterblock_screen_name' => 'DigitalAgendaEU',
    'multisite_twitterblock_rts_display_original' => '1',
    'multisite_twitterblock_result_type' => 'popular',
    'multisite_twitterblock_restr_lang_to' => 'rus',
    'multisite_twitterblock_owner_screen_name' => 'DigitalAgendaEU',
    'multisite_twitterblock_override_types[article]' => 'article',
    'multisite_twitterblock_include_rts' => '1',
    'multisite_twitterblock_incl_profiles' => '',
    'multisite_twitterblock_incl_hashtags' => 'box',
    'multisite_twitterblock_from' => '',
    'multisite_twitterblock_excl_profiles' => '',
    'multisite_twitterblock_excl_hashtags' => '',
    'multisite_twitterblock_display_user_pic' => '1',
    'multisite_twitterblock_display_user' => '1',
    'multisite_twitterblock_count' => '20',
    'form_id' => 'multisite_twitterblock_admin_settings',
  );

  /**
   * Returns test information.
   *
   * @return array
   *   Info
   */
  public static function getInfo() {
    return array(
      'name' => 'multisite twitter widget tests',
      'description' => 'Tests main twitter widget features',
      'group' => 'Multisite - Media',
    );
  }

  /**
   * Setups the main necessary modules.
   */
  public function setUp() {
    parent::setUp(array('multisite_twitterblock'));

    $https_proxy = array(
      'dae',
      'fpfis-dev.net1.cec.eu.int',
      'intragate.ec.europa.eu',
      '127.0.0.1',
      'localhost',
      'biguonia.cc.cec.eu.int',
      '158.167.39.277',
      'dbprod-dmrz.jrc.org',
      '139.191.254.129',
      'intragate.acceptance.ec.europa.eu',
      'intragate.ec.europa.eu',
    );
    variable_set('proxy_exceptions', $https_proxy);

    // Create and log in admin user.
    $admin_permissions = array(
      'access content',
      'create page content',
      'edit own page content',
      'create article content',
      'edit own article content',
      'administer fpfis twitter widget',
      'administer fpfis twitter feature',
      'override fpfis twitter widget',
    );

    $this->adminUser = $this->drupalCreateUser($admin_permissions);

    // Create and log in basic user.
    $permissions = array(
      'access content',
      'create page content',
      'edit own page content',
      'create article content',
      'edit own article content',
    );

    $this->basicUser = $this->drupalCreateUser($permissions);
  }

  /**
   * The main test of twitter widget.
   */
  public function testTwitterWidgetFeatures() {
    $this->loadAdminPageByBasicUser();
    $this->saveConfig();
    $this->checkContentSetting();
  }

  /**
   * Loads admin page by a basic user.
   */
  protected function loadAdminPageByBasicUser() {
    $this->drupalLogin($this->basicUser);
    $this->drupalGet('admin/config/content/multisite_twitterblock/twitter/', array());
    $this->assertRaw('Access denied', 'Configuration was not saved!');
    $this->drupalLogout();
  }

  /**
   * Saves config for Social Media.
   */
  protected function saveConfig() {
    $this->drupalLogin($this->adminUser);
    $this->drupalPost('admin/config/content/multisite_twitterblock/twitter/', $this->configuration, t('Save configuration'));
    $this->assertRaw('The configuration options have been saved', 'Configuration was successfully saved');
    $this->drupalLogout();
  }

  /**
   * Checks content settings.
   */
  protected function checkContentSetting() {

    // Check wether basic user has access to override twitter setting.
    $this->drupalLogin($this->basicUser);
    $this->drupalGet('node/add/article/');
    $this->assertNoField('multisite_twitterblock_override[enabled]', 'No Override settings');

    $this->drupalLogout();

    // Check wether admin user has override twitter setting on Article page.
    // (article has twitter settings).
    $this->drupalLogin($this->adminUser);
    $this->drupalGet('node/add/article/');
    $this->assertField('multisite_twitterblock_override[enabled]', 'Override settings');

    // Check wether admin user has override twitter setting on Basic page.
    // (basic page does not have twitter settings).
    $this->drupalGet('node/add/page/');
    $this->assertNoField('multisite_twitterblock_override[enabled]', 'No Override settings');
    $this->drupalLogout();
  }

}
