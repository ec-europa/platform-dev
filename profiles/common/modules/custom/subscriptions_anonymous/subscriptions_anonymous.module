<?php

/**
 * @file
 * Anonymous subscriptions module (load-on-demand admin functions).
 */

/**
 * Implements hook_FORM_ID_alter().
 */
function subscriptions_anonymous_form_subscriptions_ui_node_form_alter(&$form, &$form_state, $form_id) {
  // @TODO make it more generic than only for nodes
  if ($form['#form_id'] == 'subscriptions_ui_node_form') {
    $form['wrapper']['mail'] = array(
      '#title' => t('Email'),
      '#type' => 'textfield',
      '#access' => user_access('subscribe to content') && user_is_anonymous(),
      '#required' => user_access('subscribe to content') && user_is_anonymous(),
    );
    if (user_is_anonymous()) {
      $form['#submit'][] = '_subscriptions_anonymous_submit';
    }
  }
}

/**
 * Validation handler for subscriptions form.
 */
function _subscriptions_anonymous_validate($form, &$form_state) {
  if (!empty($form_state['values']['mail'])) {
    if (!valid_email_address($form_state['values']['mail'])) {
      form_set_error('mail', t('Email address is invalid.'));
    }
  }
}

/**
 * Validation handler for subscriptions form.
 */
function _subscriptions_anonymous_submit($form, &$form_state) {
  // Get the lower uid found and decrement it.
  $query = db_select('subscriptions_queue', 'sq');
  $query->addExpression('MIN(uid)', 'min_uid');
  $min_uid = $query->execute()
    ->fetchAssoc();
  $form_state['uid'] = 32;

}
